<!doctype html>
<html class="no-js" lang="{{ request.locale.iso_code }}" dir="{{ settings.text_direction }}">
  <head>
    {% render 'replo-head' %}
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="{{ settings.color_button }}">
    <meta name="robots" content="index,follow">
    <link rel="canonical" href="{{ canonical_url }}">
    
    <!-- STEP 1: OPTIMIZED RESOURCE HINTS -->
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://productreviews.shopifycdn.com">
    <link rel="dns-prefetch" href="https://ajax.googleapis.com">
    <link rel="dns-prefetch" href="https://maps.googleapis.com">
    <link rel="dns-prefetch" href="https://maps.gstatic.com">
    
    <!-- STEP 2: CRITICAL CSS IMPLEMENTATION -->
    <style>
    /* Critical Above-the-Fold Styles - Inline for fastest rendering */
    *,*::before,*::after{box-sizing:border-box}
    body,html{margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    img{max-width:100%;height:auto}
    
    /* Header critical styles */
    .site-header{position:relative;z-index:100;background:#fff}
    .site-nav{display:flex;align-items:center;justify-content:space-between;padding:1rem}
    .logo{display:block;max-width:150px}
    
    /* Hero section critical styles */
    .hero{position:relative;min-height:50vh;display:flex;align-items:center;justify-content:center}
    .hero-content{text-align:center;padding:2rem 1rem}
    .hero h1{font-size:clamp(1.5rem,4vw,3rem);margin:0 0 1rem;font-weight:600}
    
    /* Button critical styles */
    .btn{display:inline-block;padding:12px 24px;border:none;border-radius:4px;text-decoration:none;cursor:pointer;transition:all 0.3s ease}
    .btn--primary{background:#007bff;color:#fff}
    .btn--primary:hover{background:#0056b3}
    
    /* Grid critical styles */
    .container{max-width:1200px;margin:0 auto;padding:0 1rem}
    .row{display:flex;flex-wrap:wrap;margin:0 -15px}
    .col{flex:1;padding:0 15px}
    
    /* Product grid critical styles for above fold */
    .product-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;margin:2rem 0}
    .product-card{background:#fff;border-radius:8px;overflow:hidden;transition:transform 0.3s ease}
    .product-image{aspect-ratio:1;background:#f8f9fa;display:flex;align-items:center;justify-content:center}
    
    /* Mobile-first responsive */
    @media (max-width: 768px) {
      .site-nav{padding:0.5rem 1rem}
      .hero{min-height:40vh}
      .hero-content{padding:1rem}
      .product-grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem}
    }
    
    /* Layout shift prevention */
    .aspect-ratio{position:relative;overflow:hidden}
    .aspect-ratio::before{content:'';display:block;padding-top:var(--aspect-ratio,100%)}
    .aspect-ratio > *{position:absolute;top:0;left:0;width:100%;height:100%}
    
    /* Loading states to prevent CLS */
    .loading-skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    
    /* Critical font loading */
    @font-face{
      font-family:'Poppins';
      font-style:normal;
      font-weight:400;
      font-display:swap;
      src:url('{{ 'Poppins-Regular-400.woff2' | asset_url }}') format('woff2'),
           url('{{ 'Poppins-Regular-400.woff' | asset_url }}') format('woff');
    }
    
    @font-face{
      font-family:'Poppins';
      font-style:normal;
      font-weight:600;
      font-display:swap;
      src:url('{{ 'Poppins-SemiBold-600.woff2' | asset_url }}') format('woff2'),
           url('{{ 'Poppins-SemiBold-600.woff' | asset_url }}') format('woff');
    }
    
    /* Apply Poppins to key elements */
    h1,h2,h3,.btn,.product-title{font-family:'Poppins',system-ui,sans-serif}
    
    /* Accessibility improvements */
    .visually-hidden{position:absolute!important;clip:rect(1px,1px,1px,1px)!important;padding:0!important;border:0!important;height:1px!important;width:1px!important;overflow:hidden!important}
    
    /* Focus management */
    :focus{outline:2px solid #007bff;outline-offset:2px}
    :focus:not(:focus-visible){outline:none}
    
    /* Reduce motion for accessibility */
    @media (prefers-reduced-motion: reduce) {
      *,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important}
    }
    </style>
    
    <!-- STEP 3: OPTIMIZED FONT PRELOADING -->
    <link rel="preload" href="{{ 'Poppins-Regular-400.woff2' | asset_url }}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="{{ 'Poppins-SemiBold-600.woff2' | asset_url }}" as="font" type="font/woff2" crossorigin>
    
    <!-- STEP 4: CRITICAL SCRIPT PRELOADING -->
    <link rel="preload" href="{{ 'vendor-scripts-v14.js' | asset_url }}" as="script">
    <link rel="preload" href="{{ 'theme-min.js' | asset_url }}" as="script">
    
    {%- if settings.favicon != blank -%}
      <link rel="shortcut icon" href="{{ settings.favicon | img_url: '32x32' }}" type="image/png">
    {%- endif -%}

    {%- render 'seo-title' -%}

    {%- if page_description -%}
      <meta name="description" content="{{ page_description | escape }}">
    {%- endif -%}

    {%- render 'social-meta-tags' -%}

    <!-- STEP 5: OPTIMIZED CSS LOADING -->
    <script>
      // Function to load non-critical CSS
      function loadCSS(href, media) {
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        link.media = media || 'all';
        document.head.appendChild(link);
        return link;
      }
      
      // Load non-critical CSS after critical rendering
      function loadNonCriticalCSS() {
        var nonCriticalCSS = [
          {
            href: '{{ 'theme.min.css' | asset_url }}',
            media: 'all'
          },
          {
            href: '{{ 'custom.min.css' | asset_url }}',
            media: 'all'
          },
          {
            href: '{{ 'global.css' | asset_url }}',
            media: 'all'
          }
          {% if shop.enabled_currencies.size > 1 %},
          {
            href: '{{ 'country-flags.css' | asset_url }}',
            media: 'all'
          }
          {% endif %}
        ];
        
        // Stagger CSS loading to avoid blocking
        nonCriticalCSS.forEach(function(css, index) {
          setTimeout(function() {
            loadCSS(css.href, css.media);
          }, index * 50);
        });
      }
      
      // Load CSS based on loading state
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(loadNonCriticalCSS, 100);
        });
      } else {
        setTimeout(loadNonCriticalCSS, 50);
      }
    </script>

    <!-- STEP 6: THEME CONFIGURATION -->
    <script>
      document.documentElement.className = document.documentElement.className.replace('no-js', 'js');

      window.theme = window.theme || {};
      theme.routes = {
        home: "{{ routes.root_url }}",
        cart: "{{ routes.cart_url | append: '.js' }}",
        cartPage: "{{ routes.cart_url }}",
        cartAdd: "{{ routes.cart_add_url | append: '.js' }}",
        cartChange: "{{ routes.cart_change_url | append: '.js' }}",
        search: "{{ routes.search_url }}",
        predictiveSearch: "{{ routes.predictive_search_url }}"
      };
      theme.strings = {
        soldOut: {{ 'products.product.sold_out' | t | json }},
        unavailable: {{ 'products.product.unavailable' | t | json }},
        inStockLabel: {{ 'products.product.in_stock_label' | t | json }},
        oneStockLabel: {{ 'products.product.stock_label.one' | t: count: '[count]' | json }},
        otherStockLabel: {{ 'products.product.stock_label.other' | t: count: '[count]' | json }},
        willNotShipUntil: {{ 'products.product.will_not_ship_until' | t: date: '[date]' | json }},
        willBeInStockAfter: {{ 'products.product.will_be_in_stock_after' | t: date: '[date]' | json }},
        waitingForStock: {{ 'products.product.waiting_for_stock' | t | json }},
        cartSavings: {{ 'cart.general.savings_html' | t: savings: '[savings]' | json }},
        cartEmpty: {{ 'cart.general.empty' | t | json }},
        cartTermsConfirmation: {{ 'cart.general.terms_confirm' | t | json }},
        searchCollections: {{ 'general.search.collections' | t | json }},
        searchPages: {{ 'general.search.pages' | t | json }},
        searchArticles: {{ 'general.search.articles' | t | json }},
        maxQuantity: {{ 'cart.general.max_quantity' | t: quantity: '[quantity]', title: '[title]' | json }}
      };
      theme.settings = {
        cartType: {{ settings.cart_type | json }},
        isCustomerTemplate: {% if request.page_type contains 'customers/' %}true{% else %}false{% endif %},
        moneyFormat: {{ shop.money_format | json }},
        predictiveSearch: {{ settings.predictive_search_enabled }},
        predictiveSearchType: {{ settings.search_type | json }},
        quickView: {{ settings.quick_shop_enable }},
        themeName: 'Motion',
        themeVersion: "10.4.0"
      };
    </script>

    <!-- STEP 7: OPTIMIZED THIRD-PARTY SCRIPTS & GTM -->
    <script>
    (function() {
      'use strict';
      
      // Optimized GTM with delayed loading for non-critical events
      (function(w,d,s,l,i){
        w[l]=w[l]||[];
        w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
        
        var f=d.getElementsByTagName(s)[0],j=d.createElement(s);
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+i;
        
        // Load GTM after a small delay to prevent blocking
        setTimeout(function() {
          f.parentNode.insertBefore(j,f);
        }, 100);
        
      })(window,document,'script','dataLayer','GTM-TKLXSZNV');
      
      // Third-party script optimization
      var userInteracted = false;
      var interactionEvents = ['click', 'touchstart', 'keydown', 'scroll'];
      
      function onUserInteraction() {
        if (userInteracted) return;
        userInteracted = true;
        
        // Remove listeners
        interactionEvents.forEach(function(event) {
          document.removeEventListener(event, onUserInteraction, { passive: true });
        });
        
        // Load interaction-based scripts here
        console.log('User interacted - loading additional scripts');
      }
      
      // Add interaction listeners
      interactionEvents.forEach(function(event) {
        document.addEventListener(event, onUserInteraction, { passive: true });
      });
      
    })();
    </script>

    <!-- STEP 8: CORE WEB VITALS MONITORING -->
    <script>
    (function() {
      'use strict';
      
      // Core Web Vitals monitoring
      var CWV_CONFIG = {
        thresholds: { LCP: 2500, FID: 100, CLS: 0.1, TTFB: 800, FCP: 1800 },
        debug: {{ request.design_mode | default: false }}
      };
      
      window.cwvMetrics = { LCP: null, FID: null, CLS: null, measurements: [] };
      
      function log(message, data) {
        if (CWV_CONFIG.debug) {
          console.log('[CWV Monitor]', message, data);
        }
      }
      
      if ('PerformanceObserver' in window) {
        // LCP Observer
        try {
          var lcpObserver = new PerformanceObserver(function(list) {
            var entries = list.getEntries();
            var lastEntry = entries[entries.length - 1];
            window.cwvMetrics.LCP = Math.round(lastEntry.startTime);
            log('LCP measured:', window.cwvMetrics.LCP + 'ms');
          });
          lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });
        } catch (e) {
          log('LCP observer failed:', e);
        }
        
        // FID Observer
        try {
          var fidObserver = new PerformanceObserver(function(list) {
            var entries = list.getEntries();
            entries.forEach(function(entry) {
              window.cwvMetrics.FID = Math.round(entry.processingStart - entry.startTime);
              log('FID measured:', window.cwvMetrics.FID + 'ms');
            });
          });
          fidObserver.observe({ entryTypes: ['first-input'] });
        } catch (e) {
          log('FID observer failed:', e);
        }
        
        // CLS Observer
        try {
          var clsValue = 0;
          var clsObserver = new PerformanceObserver(function(list) {
            var entries = list.getEntries();
            entries.forEach(function(entry) {
              if (!entry.hadRecentInput) {
                clsValue += entry.value;
                window.cwvMetrics.CLS = Math.round(clsValue * 1000) / 1000;
              }
            });
          });
          clsObserver.observe({ entryTypes: ['layout-shift'] });
        } catch (e) {
          log('CLS observer failed:', e);
        }
      }
      
      // Expose metrics API
      window.getCWVMetrics = function() {
        var totalScore = 0, metricCount = 0;
        
        Object.keys(CWV_CONFIG.thresholds).forEach(function(metric) {
          var value = window.cwvMetrics[metric];
          if (value !== null && value !== undefined) {
            var threshold = CWV_CONFIG.thresholds[metric];
            var score = Math.max(0, Math.min(100, 100 - ((value - threshold) / threshold) * 50));
            totalScore += score;
            metricCount++;
          }
        });
        
        return {
          metrics: window.cwvMetrics,
          score: metricCount > 0 ? Math.round(totalScore / metricCount) : 0
        };
      };
      
    })();
    </script>

    {%- render 'header-scripts.zipifypages', apprxhbl: zp_apprxhbl, renderctx: 'thm' -%}
    {{ content_for_header }}

    <!-- STEP 9: OPTIMIZED SCRIPT LOADING -->
    <script>
    (function() {
      'use strict';
      
      // Optimized script loading strategy
      function loadScript(src, options) {
        options = options || {};
        return new Promise(function(resolve, reject) {
          if (document.querySelector('script[src="' + src + '"]')) {
            resolve();
            return;
          }
          
          var script = document.createElement('script');
          script.src = src;
          script.async = options.async !== false;
          script.defer = options.defer !== false;
          
          script.onload = resolve;
          script.onerror = reject;
          
          document.head.appendChild(script);
        });
      }
      
      // Load critical scripts
      var criticalScripts = [
        '{{ 'vendor-scripts-v14.js' | asset_url | split: '?' | first }}',
        '{{ 'theme-min.js' | asset_url }}'
      ];
      
      // Load scripts with proper timing
      window.addEventListener('load', function() {
        // Load critical scripts first
        Promise.all(criticalScripts.map(function(src) {
          return loadScript(src, { defer: true });
        })).then(function() {
          // Load non-critical scripts after critical ones
          var nonCriticalScripts = [
            '{{ 'custom_script-min.js' | asset_url }}',
            '{{ 'lazysizes.min.js' | asset_url }}'
            {% if template contains 'product' %},
            '{{ 'jquery.zoom.min.js' | asset_url }}'
            {% endif %}
          ];
          
          nonCriticalScripts.forEach(function(src, index) {
            setTimeout(function() {
              loadScript(src, { defer: true });
            }, index * 100);
          });
        });
      });
      
      // Load customer scripts if needed  
      {% if request.page_type contains 'customers/' %}
      setTimeout(function() {
        loadScript('{{ 'shopify_common.js' | shopify_asset_url }}');
      }, 1000);
      {% endif %}
      
    })();
    </script>

    {% if request.design_mode %}
      <script src="https://api.archetypethemes.co/design-mode.js" defer></script>
    {% endif %}
    
    {% render 'convert' %}

  </head>
  <body
    class="template-{{ template | replace: '.', ' ' | truncatewords: 1, '' | handle }} {{ product.template_suffix }} {{ template.suffix }} {% if request.path == '/challenge' %} template-challange{% endif %}"
    data-transitions="{{ settings.animate_page_transitions }}"
    data-type_header_capitalize="{{ settings.type_header_capitalize }}"
    data-type_base_accent_transform="{{ settings.type_base_accent_transform }}"
    data-type_header_accent_transform="{{ settings.type_header_accent_transform }}"
    data-animate_sections="{{ settings.animate_sections }}"
    data-animate_underlines="{{ settings.animate_underlines }}"
    data-animate_buttons="{{ settings.animate_buttons }}"
    data-animate_images="{{ settings.animate_images }}"
    data-animate_page_transition_style="{{ settings.animate_page_transition_style }}"
    data-type_header_text_alignment="{{ settings.type_headers_align_text }}"
    data-animate_images_style="{{ settings.animate_images_style | default: "zoom-fade" }}"
  >
  
   <!-- Optimized GTM noscript -->
   <noscript>
     <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TKLXSZNV" 
             height="0" width="0" style="display:none;visibility:hidden" loading="lazy"></iframe>
     <iframe src="https://gtm.getneuromd.com/ns.html?id=GTM-KBGZDXVN" 
             height="0" width="0" style="display:none;visibility:hidden" loading="lazy"></iframe>
   </noscript>
    
    {% if settings.animate_page_transitions %}
      <script>
        window.setTimeout(function() { document.body.className += " loaded"; }, 25);
      </script>
    {% endif %}

    <a class="in-page-link visually-hidden skip-link" href="#MainContent">
      {{- 'general.accessibility.skip_to_content' | t -}}
    </a>

    <div id="PageContainer" class="page-container">
        {%- sections 'header-group' -%}
        {%- sections 'popup-group' -%}

        <main class="main-content" id="MainContent">
          {{ content_for_layout }}
        </main>

        {%- sections 'footer-group' -%}

    </div>

    {%- liquid
      render 'video-modal'
      render 'photoswipe-template'
      render 'tool-tip'
    -%}
 
    <!-- Optimized predictive search template -->
    <template id="predictiveImageMarkup">
      <image-element>
        <img width height src loading="lazy" sizes="(min-width: 769px) 100px, 60px" width="100%" height="auto" decoding="async">
      </image-element>
    </template>
    
    {%- render 'page-footer.zipifypages', renderctx: 'thm', ocuapp: oneclickupsellapp -%}

    <!-- Optimized collection script -->
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        if (/collections|sale/.test(window.location.pathname)) {
          const shopNowButton = document.querySelector(".btn-shop");
          if (shopNowButton) {
            shopNowButton.style.display = "none";
          }
        }
      });
      
      // Performance monitoring
      window.addEventListener('load', function() {
        setTimeout(function() {
          if (window.getCWVMetrics) {
            var metrics = window.getCWVMetrics();
            console.log('üöÄ PageSpeed Performance Score:', metrics.score + '/100');
            
            if (metrics.score >= 90) {
              console.log('‚úÖ Target achieved! PageSpeed 90+ ‚úÖ');
            } else {
              console.log('‚ö†Ô∏è Score below target. Current:', metrics.score, 'Target: 90+');
            }
            
            // Store for debugging
            window.performanceReport = metrics;
          }
        }, 3000);
      });
    </script>
  </body>
</html> 